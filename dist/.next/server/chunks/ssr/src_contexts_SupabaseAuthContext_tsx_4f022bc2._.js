module.exports=[43897,86130,58,a=>{"use strict";var b=a.i(87924),c=a.i(72131),d=a.i(10849);d.supabase;class e{channels=new Map;getClient(){return d.supabase}async getCurrentUser(){let{data:{user:a}}=await d.supabase.auth.getUser();return a}async getCurrentSession(){let{data:{session:a}}=await d.supabase.auth.getSession();return a}async getUserProfile(a){let{data:b,error:c}=await d.supabase.from("users").select("*").eq("id",a).single();return c?(console.error("Error fetching user profile:",c),null):b}async updateUserProfile(a,b){let{data:c,error:e}=await d.supabase.from("users").update(b).eq("id",a).select().single();return e?(console.error("Error updating user profile:",e),null):c}async createUserProfile(a,b){let c={id:a.id,email:a.email||"",username:b?.username||a.email?.split("@")[0]||"user",full_name:b?.full_name||a.user_metadata?.full_name||"",avatar_url:a.user_metadata?.avatar_url||"",points:0,level:1,streak:0,longest_streak:0,status:"active"};try{let{data:b,error:e}=await d.supabase.from("users").insert(c).select().single();if(e){if(console.error("Error creating user profile:",e),e.message.includes("column")&&e.message.includes("username")){let{data:b,error:e}=await d.supabase.from("users").insert({id:c.id,email:c.email,full_name:c.full_name,avatar_url:c.avatar_url,points:c.points,level:c.level,streak:c.streak,longest_streak:c.longest_streak,status:c.status}).select().single();if(e)return console.error("Error creating user profile without username:",e),null;return await this.createUserStats(a.id),b}return null}return await this.createUserStats(a.id),b}catch(a){return console.error("Error creating user profile:",a),null}}async getUserStats(a){let{data:b,error:c}=await d.supabase.from("user_stats").select("*").eq("user_id",a).single();return c?(console.error("Error fetching user stats:",c),null):b}async updateUserStats(a,b){let{data:c,error:e}=await d.supabase.from("user_stats").update(b).eq("user_id",a).select().single();return e?(console.error("Error updating user stats:",e),null):c}async createUserStats(a){let{data:b,error:c}=await d.supabase.from("user_stats").insert({user_id:a,verses_read:0,chapters_completed:0,devotionals_created:0,prayers_shared:0,friends_count:0,reading_time_minutes:0}).select().single();return c?(console.error("Error creating user stats:",c),null):b}async addPoints(a,b){let c=await this.getUserProfile(a);if(!c)return null;let d=c.points+b,e=Math.floor(d/1e3)+1;return await this.updateUserProfile(a,{points:d,level:e})}async updateStreak(a,b){let c=await this.getUserProfile(a);if(!c)return null;let d=Math.max(c.longest_streak,b);return await this.updateUserProfile(a,{streak:b,longest_streak:d})}async updateReadingProgress(a,b,c,d=1){let e=await this.getUserStats(a);return e?await this.updateUserStats(a,{verses_read:e.verses_read+d,chapters_completed:e.chapters_completed+ +(d>0)}):null}async createDevotional(a){let b=await this.getUserStats(a);return b?await this.updateUserStats(a,{devotionals_created:b.devotionals_created+1}):null}async createDevotionalContent(a,b){try{let{data:c}=await this.getClient().auth.getUser();if(console.log("Auth check:",c),!c.user)return console.error("User not authenticated"),null;console.log("Creating devotional with data:",{userId:a,devotionalData:b});let{data:d,error:e}=await this.getClient().from("devotionals").insert({user_id:a,title:b.title,content:b.content,verse_reference:b.verse_reference,verse_text:b.verse_text,author_name:b.author_name||"Anonymous",tags:b.tags||[],is_public:!1!==b.is_public}).select().single();if(console.log("Supabase response:",{data:d,error:e}),e)return console.error("Error creating devotional:",{message:e.message,details:e.details,hint:e.hint,code:e.code}),null;return await this.addPoints(a,20),await this.createDevotional(a),d}catch(a){return console.error("Error creating devotional (catch):",{error:a,message:a instanceof Error?a.message:"Unknown error",stack:a instanceof Error?a.stack:void 0}),null}}async createReadingPlan(a,b){try{let{data:c,error:d}=await this.getClient().from("reading_plans").insert({user_id:a,title:b.title,description:b.description,duration:b.duration,difficulty:b.difficulty||"beginner",category:b.category,verses_per_day:b.verses_per_day||3,is_public:!1!==b.is_public}).select().single();if(d)return console.error("Error creating reading plan:",d),null;return await this.addPoints(a,15),c}catch(a){return console.error("Error creating reading plan:",a),null}}async startReadingPlan(a,b){try{let{data:c,error:d}=await this.getClient().from("user_reading_plans").insert({user_id:a,plan_id:b,started_at:new Date().toISOString(),current_day:1,is_active:!0}).select().single();if(d)return console.error("Error starting reading plan:",d),null;return await this.addPoints(a,5),c}catch(a){return console.error("Error starting reading plan:",a),null}}async sharePrayer(a){let b=await this.getUserStats(a);return b?await this.updateUserStats(a,{prayers_shared:b.prayers_shared+1}):null}async addReadingTime(a,b){let c=await this.getUserStats(a);return c?await this.updateUserStats(a,{reading_time_minutes:c.reading_time_minutes+b}):null}async getUserAchievements(b){try{let{data:c,error:d}=await this.getClient().from("user_achievements").select("*").eq("user_id",b);if(d)return console.error("Error fetching user achievements:",d),[];if(!c||0===c.length)return[];let{achievements:e}=await a.A(88534);c.map(a=>a.achievement_id);let f=new Map(e.map(a=>[a.id,a]));return c.map(a=>({id:a.id,user_id:a.user_id,achievement_id:a.achievement_id,unlocked_at:a.unlocked_at,points_awarded:a.points_awarded,achievement:f.get(a.achievement_id)||null}))}catch(a){return console.error("Error in getUserAchievements:",a),[]}}async unlockAchievement(a,b){try{let{data:c}=await this.getClient().from("user_achievements").select("id").eq("user_id",a).eq("achievement_id",b).maybeSingle();if(c)return!0;let{error:d}=await this.getClient().from("user_achievements").insert({user_id:a,achievement_id:b,unlocked_at:new Date().toISOString()});if(d)return console.error("Error unlocking achievement:",d),!1;return!0}catch(a){return console.error("Error unlocking achievement:",a),!1}}async getLeaderboard(a=50){try{console.log("Fetching leaderboard data from optimized table...");let{data:b,error:c}=await d.supabase.from("leaderboard_view").select("*").order("rank_position",{ascending:!0}).limit(a);if(console.log("Leaderboard query result:",{data:b,error:c,count:b?.length}),c)throw c;return b?.map(a=>({id:a.user_id,username:a.username,email:a.email,full_name:a.full_name,avatar_url:a.avatar_url,points:a.total_points,level:a.level,streak:a.streak,longest_streak:a.longest_streak,status:"active",created_at:a.user_created_at,updated_at:a.updated_at}))||[]}catch(b){return console.error("Error fetching leaderboard:",b),this.getLeaderboardFallback(a)}}async getLeaderboardFallback(a=50){try{console.log("Using fallback leaderboard query...");let b=d.supabase.from("users").select("*");try{b=b.eq("status","active")}catch(a){console.log("Status column might not exist, skipping status filter")}let{data:c,error:e}=await b.order("points",{ascending:!1}).limit(a);if(console.log("Fallback leaderboard query result:",{data:c,error:e,count:c?.length}),e)throw e;return c||[]}catch(a){return console.error("Fallback query also failed:",a),[]}}async getWeeklyLeaderboard(a=50){try{console.log("Fetching weekly leaderboard data from optimized table...");let{data:b,error:c}=await d.supabase.from("leaderboard").select("*").order("weekly_points",{ascending:!1}).limit(a);if(console.log("Weekly leaderboard query result:",{data:b,error:c,count:b?.length}),c)throw c;return b?.map(a=>({id:a.user_id,username:a.username,email:"",full_name:"",avatar_url:a.avatar_url,points:a.weekly_points,level:a.level,streak:a.streak,longest_streak:a.longest_streak,status:"active",created_at:a.created_at,updated_at:a.updated_at}))||[]}catch(b){return console.error("Error fetching weekly leaderboard:",b),this.getWeeklyLeaderboardFallback(a)}}async getWeeklyLeaderboardFallback(a=50){try{console.log("Using fallback weekly leaderboard query...");let b=new Date;b.setDate(b.getDate()-7);let c=d.supabase.from("users").select("*").gte("updated_at",b.toISOString());try{c=c.eq("status","active")}catch(a){console.log("Status column might not exist, skipping status filter for weekly leaderboard")}let{data:e,error:f}=await c.order("points",{ascending:!1}).limit(a);if(console.log("Fallback weekly leaderboard query result:",{data:e,error:f,count:e?.length}),f)throw f;return e||[]}catch(a){return console.error("Fallback weekly query also failed:",a),[]}}async getStreakLeaderboard(a=50){try{console.log("Fetching streak leaderboard data from optimized table...");let{data:b,error:c}=await d.supabase.from("leaderboard").select("*").order("streak",{ascending:!1}).limit(a);if(console.log("Streak leaderboard query result:",{data:b,error:c,count:b?.length}),c)throw c;return b?.map(a=>({id:a.user_id,username:a.username,email:"",full_name:"",avatar_url:a.avatar_url,points:a.total_points,level:a.level,streak:a.streak,longest_streak:a.longest_streak,status:"active",created_at:a.created_at,updated_at:a.updated_at}))||[]}catch(b){return console.error("Error fetching streak leaderboard:",b),this.getStreakLeaderboardFallback(a)}}async getStreakLeaderboardFallback(a=50){try{console.log("Using fallback streak leaderboard query...");let b=d.supabase.from("users").select("*");try{b=b.eq("status","active")}catch(a){console.log("Status column might not exist, skipping status filter for streak leaderboard")}let{data:c,error:e}=await b.order("streak",{ascending:!1}).limit(a);if(console.log("Fallback streak leaderboard query result:",{data:c,error:e,count:c?.length}),e)throw e;return c||[]}catch(a){return console.error("Fallback streak query also failed:",a),[]}}async getUserRank(a){try{let{data:b,error:c}=await d.supabase.from("leaderboard").select("rank_position").eq("user_id",a).single();if(!c&&b)return b.rank_position;let{data:e,error:f}=await d.supabase.from("users").select("points").eq("id",a).single();if(f)throw f;let{count:g,error:h}=await d.supabase.from("users").select("*",{count:"exact",head:!0}).eq("status","active").gt("points",e.points);if(h)throw h;return(g||0)+1}catch(a){return console.error("Error fetching user rank:",a),1}}subscribeToLeaderboard(a){let b="leaderboard_updates";if(this.channels.has(b))return this.channels.get(b);let c=d.supabase.channel(b).on("postgres_changes",{event:"*",schema:"public",table:"leaderboard"},async()=>{a(await this.getLeaderboard(50))}).subscribe();return this.channels.set(b,c),c}subscribeToUserRanking(a,b){let c=`user_ranking_${a}`;if(this.channels.has(c))return this.channels.get(c);let e=d.supabase.channel(c).on("postgres_changes",{event:"*",schema:"public",table:"leaderboard",filter:`user_id=eq.${a}`},async a=>{"UPDATE"===a.eventType&&a.new&&b(a.new)}).subscribe();return this.channels.set(c,e),e}subscribeToUser(a,b){let c=`user_${a}`;if(this.channels.has(c))return this.channels.get(c);let e=d.supabase.channel(c).on("postgres_changes",{event:"*",schema:"public",table:"users",filter:`id=eq.${a}`},a=>{"UPDATE"===a.eventType&&a.new&&b(a.new)}).subscribe();return this.channels.set(c,e),e}subscribeToUserStats(a,b){let c=`user_stats_${a}`;if(this.channels.has(c))return this.channels.get(c);let e=d.supabase.channel(c).on("postgres_changes",{event:"*",schema:"public",table:"user_stats",filter:`user_id=eq.${a}`},a=>{"UPDATE"===a.eventType&&a.new&&b(a.new)}).subscribe();return this.channels.set(c,e),e}unsubscribe(a){let b=this.channels.get(a);b&&(d.supabase.removeChannel(b),this.channels.delete(a))}unsubscribeAll(){this.channels.forEach(a=>{d.supabase.removeChannel(a)}),this.channels.clear()}}let f=new e;a.s(["supabaseService",0,f],86130);let g=class{static async getReferralInfo(a){try{console.log("Getting referral info for userId:",a);let{data:b,error:c}=await d.supabase.from("users").select("username, referral_code, email").eq("id",a).single();if(console.log("User data:",b),console.log("User error:",c),c){console.error("Error fetching user:",c),console.error("Error details:",JSON.stringify(c,null,2)),console.error("Error code:",c.code),console.error("Error message:",c.message),console.error("Error details:",c.details);let{data:a}=await d.supabase.auth.getUser();if(a.user&&a.user.email){let b=a.user.email.split("@")[0].toLowerCase().replace(/[^a-zA-Z0-9]/g,"");return console.log("Using auth email for referral code:",b),{referral_code:b,referral_url:`${window.location.origin}/auth?ref=${b}`,total_referrals:0,completed_referrals:0,pending_referrals:0,points_earned:0}}return null}if(!b)return console.log("No user data found"),null;let e=b.referral_code||b.username||b.email.split("@")[0].toLowerCase();console.log("Using referral code:",e);let{data:f,error:g}=await d.supabase.from("referrals").select("status, points_awarded").eq("referrer_id",a);if(console.log("Referrals data:",f),console.log("Referrals error:",g),g)return console.error("Error fetching referrals:",g),{referral_code:e,referral_url:`${window.location.origin}/auth?ref=${e}`,total_referrals:0,completed_referrals:0,pending_referrals:0,points_earned:0};let h=f||[],i=h.filter(a=>"completed"===a.status).length,j=h.filter(a=>"pending"===a.status).length,k=h.reduce((a,b)=>a+(b.points_awarded||0),0);return{referral_code:e,referral_url:`${window.location.origin}/auth?ref=${e}`,total_referrals:h.length,completed_referrals:i,pending_referrals:j,points_earned:k}}catch(a){return console.error("Error getting referral info:",a),null}}static async processReferral(a,b){try{let{data:c,error:e}=await d.supabase.from("users").select("id").eq("referral_code",a).single();if(e||!c)return!1;let{data:f}=await d.supabase.from("referrals").select("id").eq("referred_id",b).single();if(f)return!1;await d.supabase.from("users").update({referred_by:c.id}).eq("id",b);let{error:g}=await d.supabase.from("referrals").insert({referrer_id:c.id,referred_id:b,referral_code:a,status:"pending",points_awarded:0});if(g)throw g;return!0}catch(a){return console.error("Error processing referral:",a),!1}}static async completeReferral(a){try{let{data:b,error:c}=await d.supabase.from("referrals").select("*").eq("id",a).single();if(c||!b)throw c;let{error:e}=await d.supabase.from("referrals").update({status:"completed",points_awarded:100,completed_at:new Date().toISOString()}).eq("id",a);if(e)throw e;await f.addPoints(b.referrer_id,100),await d.supabase.from("points_transactions").insert({user_id:b.referrer_id,transaction_type:"referral",points:100,description:"Referral bonus",metadata:{referred_user:b.referred_id,referral_code:b.referral_code}}),await d.supabase.from("user_stats").update({referrals_completed:d.supabase.rpc("increment",{amount:1}),total_points_earned:d.supabase.rpc("increment",{amount:100})}).eq("user_id",b.referrer_id),await f.addPoints(b.referred_id,50),await d.supabase.from("points_transactions").insert({user_id:b.referred_id,transaction_type:"referral",points:50,description:"Welcome bonus",metadata:{referred_by:b.referrer_id,referral_code:b.referral_code}}),await d.supabase.from("user_stats").update({total_points_earned:d.supabase.rpc("increment",{amount:50})}).eq("user_id",b.referred_id)}catch(a){throw console.error("Error completing referral:",a),a}}static generateReferralUrl(a){return`${window.location.origin}/auth?ref=${a}`}static async validateReferralCode(a){try{let{data:b,error:c}=await d.supabase.from("users").select("id").eq("referral_code",a).single();return!c&&!!b}catch(a){return!1}}static async getReferralHistory(a){try{let{data:b,error:c}=await d.supabase.from("referrals").select(`
          *,
          referred_user:referred_id(id, username, email, created_at)
        `).eq("referrer_id",a).order("created_at",{ascending:!1});if(c)throw c;return b||[]}catch(a){return console.error("Error getting referral history:",a),[]}}static async checkPendingReferrals(a){try{let b=await f.getUserProfile(a);if(!b)return;if(b.points>0||b.streak>0){let{data:b}=await d.supabase.from("referrals").select("id").eq("referred_id",a).eq("status","pending");b&&b.length>0&&await this.completeReferral(b[0].id)}}catch(a){console.error("Error checking pending referrals:",a)}}};a.s(["referralService",0,g],58);let h=(0,c.createContext)(void 0);function i({children:a}){let[e,f]=(0,c.useState)(null),[i,j]=(0,c.useState)(null),[k,l]=(0,c.useState)(!0);(0,c.useEffect)(()=>{(async()=>{try{let{data:{session:a},error:b}=await d.supabase.auth.getSession();b?(console.error("Error getting initial session:",b),(b.message?.includes("Refresh Token Not Found")||b.message?.includes("Invalid Refresh Token"))&&(console.log("Invalid refresh token, clearing session"),await d.supabase.auth.signOut(),j(null),f(null))):(console.log("Initial session:",a?.user?.email),j(a),f(a?.user??null))}catch(a){console.error("Error getting initial session:",a),j(null),f(null)}finally{l(!1)}})();let{data:{subscription:a}}=d.supabase.auth.onAuthStateChange(async(a,b)=>{console.log("Auth state changed:",a,b?.user?.email),"TOKEN_REFRESHED"!==a||b||(console.log("Token refresh failed, signing out"),await d.supabase.auth.signOut()),j(b),f(b?.user??null),l(!1)});return()=>a.unsubscribe()},[]);let m=async(a,b,c,e)=>{try{if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(a))return{success:!1,error:"Please enter a valid email address",message:"Please enter a valid email address"};if(b.length<6)return{success:!1,error:"Password must be at least 6 characters long",message:"Password must be at least 6 characters long"};console.log("Attempting sign up for:",a);let{data:f,error:h}=await d.supabase.auth.signUp({email:a,password:b,options:{data:{full_name:c||a.split("@")[0]},emailRedirectTo:`${window.location.origin}/auth/callback`}});if(h)return console.error("Supabase sign up error:",h),{success:!1,error:h.message||"Failed to create account",message:h.message||"Failed to create account"};if(console.log("Sign up response:",f),e&&f.user&&(console.log("Processing referral:",e),await g.processReferral(e,f.user.id)),f.user&&!f.user.email_confirmed_at)return{success:!0,message:"Please check your email to confirm your account.",needsConfirmation:!0};return{success:!0,message:"Account created successfully!"}}catch(a){return console.error("Unexpected sign up error:",a),{success:!1,error:a.message||"An unexpected error occurred",message:a.message||"An unexpected error occurred"}}},n=async(a,b)=>{try{if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(a))return{error:{message:"Please enter a valid email address"}};if(!b)return{error:{message:"Password is required"}};console.log("Attempting sign in for:",a);let{data:c,error:e}=await d.supabase.auth.signInWithPassword({email:a,password:b});if(e)return console.error("Supabase sign in error:",e),{error:e};if(c.user){console.log("Awarding daily login points to:",c.user.id);try{let{data:a,error:b}=await d.supabase.rpc("award_daily_login_points",{user_uuid:c.user.id});b?console.error("Error awarding daily points:",b):console.log("Daily login points awarded:",a)}catch(a){console.error("Error calling daily points function:",a)}try{await g.checkPendingReferrals(c.user.id)}catch(a){console.error("Error checking pending referrals:",a)}}return console.log("Sign in successful:",c.user?.email),{error:null}}catch(a){return console.error("Unexpected sign in error:",a),{error:{message:"An unexpected error occurred"}}}},o=async()=>{try{await d.supabase.auth.signOut(),j(null),f(null),console.log("User signed out successfully")}catch(a){console.error("Error signing out:",a),j(null),f(null)}},p=async a=>{let{error:b}=await d.supabase.auth.resetPasswordForEmail(a);return{error:b}};return(0,b.jsx)(h.Provider,{value:{user:e,session:i,loading:k,signUp:m,signIn:n,signOut:o,resetPassword:p},children:a})}function j(){let a=(0,c.useContext)(h);if(void 0===a)throw Error("useAuth must be used within an AuthProvider");return a}a.s(["AuthProvider",()=>i,"useAuth",()=>j],43897)}];

//# sourceMappingURL=src_contexts_SupabaseAuthContext_tsx_4f022bc2._.js.map