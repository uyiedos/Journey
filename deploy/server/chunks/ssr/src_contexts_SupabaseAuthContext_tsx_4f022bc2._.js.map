{"version":3,"sources":["../../../../src/contexts/SupabaseAuthContext.tsx","../../../../src/services/supabaseService.ts","../../../../src/services/referralService.ts"],"sourcesContent":["'use client';\r\n\r\nimport React, { createContext, useContext, useEffect, useState } from 'react';\r\nimport { User, Session } from '@supabase/supabase-js';\r\nimport { supabase } from '@/lib/supabase';\r\nimport { referralService } from '@/services/referralService';\r\n\r\ninterface AuthContextType {\r\n  user: User | null;\r\n  session: Session | null;\r\n  loading: boolean;\r\n  signUp: (email: string, password: string, fullName?: string, referralCode?: string) => Promise<{ \r\n    success: boolean; \r\n    message?: string; \r\n    error?: string; \r\n    needsConfirmation?: boolean \r\n  }>;\r\n  signIn: (email: string, password: string) => Promise<{ error: any }>;\r\n  signOut: () => Promise<void>;\r\n  resetPassword: (email: string) => Promise<{ error: any }>;\r\n}\r\n\r\nconst AuthContext = createContext<AuthContextType | undefined>(undefined);\r\n\r\nexport function AuthProvider({ children }: { children: React.ReactNode }) {\r\n  const [user, setUser] = useState<User | null>(null);\r\n  const [session, setSession] = useState<Session | null>(null);\r\n  const [loading, setLoading] = useState(true);\r\n\r\n  useEffect(() => {\r\n    // Get initial session\r\n    const getInitialSession = async () => {\r\n      try {\r\n        const { data: { session }, error } = await supabase.auth.getSession();\r\n        \r\n        if (error) {\r\n          console.error('Error getting initial session:', error);\r\n          \r\n          // If refresh token is invalid, clear session and force re-auth\r\n          if (error.message?.includes('Refresh Token Not Found') || \r\n              error.message?.includes('Invalid Refresh Token')) {\r\n            console.log('Invalid refresh token, clearing session');\r\n            await supabase.auth.signOut();\r\n            setSession(null);\r\n            setUser(null);\r\n          }\r\n        } else {\r\n          console.log('Initial session:', session?.user?.email);\r\n          setSession(session);\r\n          setUser(session?.user ?? null);\r\n        }\r\n      } catch (error) {\r\n        console.error('Error getting initial session:', error);\r\n        setSession(null);\r\n        setUser(null);\r\n      } finally {\r\n        setLoading(false);\r\n      }\r\n    };\r\n\r\n    getInitialSession();\r\n\r\n    // Listen for auth changes\r\n    const { data: { subscription } } = supabase.auth.onAuthStateChange(\r\n      async (event, session) => {\r\n        console.log('Auth state changed:', event, session?.user?.email);\r\n        \r\n        // Handle token refresh errors\r\n        if (event === 'TOKEN_REFRESHED' && !session) {\r\n          console.log('Token refresh failed, signing out');\r\n          await supabase.auth.signOut();\r\n        }\r\n        \r\n        setSession(session);\r\n        setUser(session?.user ?? null);\r\n        setLoading(false);\r\n      }\r\n    );\r\n\r\n    return () => subscription.unsubscribe();\r\n  }, []);\r\n\r\n  const signUp = async (email: string, password: string, fullName?: string, referralCode?: string) => {\r\n    try {\r\n      const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\r\n      if (!emailRegex.test(email)) {\r\n        return { \r\n          success: false, \r\n          error: 'Please enter a valid email address',\r\n          message: 'Please enter a valid email address'\r\n        };\r\n      }\r\n\r\n      if (password.length < 6) {\r\n        return { \r\n          success: false, \r\n          error: 'Password must be at least 6 characters long',\r\n          message: 'Password must be at least 6 characters long'\r\n        };\r\n      }\r\n\r\n      console.log('Attempting sign up for:', email);\r\n      \r\n      const { data, error } = await supabase.auth.signUp({\r\n        email,\r\n        password,\r\n        options: {\r\n          data: {\r\n            full_name: fullName || email.split('@')[0],\r\n          },\r\n          emailRedirectTo: `${window.location.origin}/auth/callback`,\r\n        },\r\n      });\r\n\r\n      if (error) {\r\n        console.error('Supabase sign up error:', error);\r\n        return { \r\n          success: false, \r\n          error: error.message || 'Failed to create account',\r\n          message: error.message || 'Failed to create account'\r\n        };\r\n      }\r\n\r\n      console.log('Sign up response:', data);\r\n\r\n      // Process referral if provided and user was created\r\n      if (referralCode && data.user) {\r\n        console.log('Processing referral:', referralCode);\r\n        await referralService.processReferral(referralCode, data.user.id);\r\n      }\r\n\r\n      if (data.user && !data.user.email_confirmed_at) {\r\n        return { \r\n          success: true, \r\n          message: 'Please check your email to confirm your account.',\r\n          needsConfirmation: true \r\n        };\r\n      }\r\n\r\n      return { success: true, message: 'Account created successfully!' };\r\n    } catch (error: any) {\r\n      console.error('Unexpected sign up error:', error);\r\n      return { \r\n        success: false, \r\n        error: error.message || 'An unexpected error occurred',\r\n        message: error.message || 'An unexpected error occurred'\r\n      };\r\n    }\r\n  };\r\n\r\n  const signIn = async (email: string, password: string) => {\r\n    try {\r\n      const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\r\n      if (!emailRegex.test(email)) {\r\n        return { error: { message: 'Please enter a valid email address' } };\r\n      }\r\n\r\n      if (!password) {\r\n        return { error: { message: 'Password is required' } };\r\n      }\r\n\r\n      console.log('Attempting sign in for:', email);\r\n      \r\n      const { data, error } = await supabase.auth.signInWithPassword({\r\n        email,\r\n        password,\r\n      });\r\n\r\n      if (error) {\r\n        console.error('Supabase sign in error:', error);\r\n        return { error };\r\n      }\r\n\r\n      // Award daily login points\r\n      if (data.user) {\r\n        console.log('Awarding daily login points to:', data.user.id);\r\n        try {\r\n          const { data: pointsData, error: pointsError } = await supabase\r\n            .rpc('award_daily_login_points', { user_uuid: data.user.id });\r\n          \r\n          if (pointsError) {\r\n            console.error('Error awarding daily points:', pointsError);\r\n          } else {\r\n            console.log('Daily login points awarded:', pointsData);\r\n          }\r\n        } catch (pointsError) {\r\n          console.error('Error calling daily points function:', pointsError);\r\n        }\r\n\r\n        // Check for pending referrals to complete\r\n        try {\r\n          await referralService.checkPendingReferrals(data.user.id);\r\n        } catch (referralError) {\r\n          console.error('Error checking pending referrals:', referralError);\r\n        }\r\n      }\r\n\r\n      console.log('Sign in successful:', data.user?.email);\r\n      return { error: null };\r\n    } catch (error: any) {\r\n      console.error('Unexpected sign in error:', error);\r\n      return { error: { message: 'An unexpected error occurred' } };\r\n    }\r\n  };\r\n\r\n  const signOut = async () => {\r\n    try {\r\n      await supabase.auth.signOut();\r\n      setSession(null);\r\n      setUser(null);\r\n      console.log('User signed out successfully');\r\n    } catch (error) {\r\n      console.error('Error signing out:', error);\r\n      // Force clear state even if signOut fails\r\n      setSession(null);\r\n      setUser(null);\r\n    }\r\n  };\r\n\r\n  const resetPassword = async (email: string) => {\r\n    const { error } = await supabase.auth.resetPasswordForEmail(email);\r\n    return { error };\r\n  };\r\n\r\n  const value = {\r\n    user,\r\n    session,\r\n    loading,\r\n    signUp,\r\n    signIn,\r\n    signOut,\r\n    resetPassword,\r\n  };\r\n\r\n  return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>;\r\n}\r\n\r\nexport function useAuth() {\r\n  const context = useContext(AuthContext);\r\n  if (context === undefined) {\r\n    throw new Error('useAuth must be used within an AuthProvider');\r\n  }\r\n  return context;\r\n}\r\n","import { supabase } from '@/lib/supabase';\r\nimport { User, Session } from '@supabase/supabase-js';\r\nimport { RealtimeChannel } from '@supabase/supabase-js';\r\n\r\n// Add getClient method for the achievement service\r\nexport const supabaseClient = supabase;\r\n\r\nexport interface UserProfile {\r\n  id: string;\r\n  username: string;\r\n  email: string;\r\n  full_name: string;\r\n  avatar_url?: string;\r\n  points: number;\r\n  level: number;\r\n  streak: number;\r\n  longest_streak: number;\r\n  status: 'active' | 'inactive' | 'suspended';\r\n  created_at: string;\r\n  updated_at: string;\r\n}\r\n\r\nexport interface UserStats {\r\n  id: string;\r\n  user_id: string;\r\n  verses_read: number;\r\n  chapters_completed: number;\r\n  devotionals_created: number;\r\n  prayers_shared: number;\r\n  friends_count: number;\r\n  reading_time_minutes: number;\r\n  community_posts: number;\r\n  reading_plans_started: number;\r\n  reading_plans_completed: number;\r\n  created_at: string;\r\n  updated_at: string;\r\n}\r\n\r\nexport interface UserAchievement {\r\n  id: string;\r\n  user_id: string;\r\n  achievement_id: string;\r\n  unlocked_at: string;\r\n  points_awarded: number;\r\n  achievement?: any;\r\n}\r\n\r\nclass SupabaseService {\r\n  private channels: Map<string, RealtimeChannel> = new Map();\r\n\r\n  // Helper method to get supabase client\r\n  getClient() {\r\n    return supabase;\r\n  }\r\n\r\n  // Authentication\r\n  async getCurrentUser(): Promise<User | null> {\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n    return user;\r\n  }\r\n\r\n  async getCurrentSession(): Promise<Session | null> {\r\n    const { data: { session } } = await supabase.auth.getSession();\r\n    return session;\r\n  }\r\n\r\n  // User Profile Management\r\n  async getUserProfile(userId: string): Promise<UserProfile | null> {\r\n    const { data, error } = await supabase\r\n      .from('users')\r\n      .select('*')\r\n      .eq('id', userId)\r\n      .single();\r\n\r\n    if (error) {\r\n      console.error('Error fetching user profile:', error);\r\n      return null;\r\n    }\r\n\r\n    return data;\r\n  }\r\n\r\n  async updateUserProfile(userId: string, updates: Partial<UserProfile>): Promise<UserProfile | null> {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('users')\r\n        .update(updates)\r\n        .eq('id', userId)\r\n        .select()\r\n        .single();\r\n\r\n      if (error) {\r\n        console.error('Error updating user profile:', {\r\n          error: error,\r\n          message: error.message,\r\n          details: error.details,\r\n          hint: error.hint,\r\n          code: error.code,\r\n          userId: userId,\r\n          updates: updates\r\n        });\r\n        return null;\r\n      }\r\n\r\n      return data;\r\n    } catch (err) {\r\n      console.error('Unexpected error in updateUserProfile:', err);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  async createUserProfile(user: User, additionalData?: { username?: string; full_name?: string }): Promise<UserProfile | null> {\r\n    const profileData = {\r\n      id: user.id,\r\n      email: user.email || '',\r\n      username: additionalData?.username || user.email?.split('@')[0] || 'user',\r\n      full_name: additionalData?.full_name || user.user_metadata?.full_name || '',\r\n      avatar_url: user.user_metadata?.avatar_url || '',\r\n      points: 0,\r\n      level: 1,\r\n      streak: 0,\r\n      longest_streak: 0,\r\n      status: 'active' as const,\r\n    };\r\n\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('users')\r\n        .insert(profileData)\r\n        .select()\r\n        .single();\r\n\r\n      if (error) {\r\n        console.error('Error creating user profile:', error);\r\n        \r\n        // If username column doesn't exist, try without it\r\n        if (error.message.includes('column') && error.message.includes('username')) {\r\n          const { data: dataWithoutUsername, error: errorWithoutUsername } = await supabase\r\n            .from('users')\r\n            .insert({\r\n              id: profileData.id,\r\n              email: profileData.email,\r\n              full_name: profileData.full_name,\r\n              avatar_url: profileData.avatar_url,\r\n              points: profileData.points,\r\n              level: profileData.level,\r\n              streak: profileData.streak,\r\n              longest_streak: profileData.longest_streak,\r\n              status: profileData.status,\r\n            })\r\n            .select()\r\n            .single();\r\n            \r\n          if (errorWithoutUsername) {\r\n            console.error('Error creating user profile without username:', errorWithoutUsername);\r\n            return null;\r\n          }\r\n          \r\n          // Create user stats\r\n          await this.createUserStats(user.id);\r\n          return dataWithoutUsername;\r\n        }\r\n        \r\n        return null;\r\n      }\r\n\r\n      // Create user stats\r\n      await this.createUserStats(user.id);\r\n      return data;\r\n    } catch (error) {\r\n      console.error('Error creating user profile:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  // User Stats Management\r\n  async getUserStats(userId: string): Promise<UserStats | null> {\r\n    const { data, error } = await supabase\r\n      .from('user_stats')\r\n      .select('*')\r\n      .eq('user_id', userId)\r\n      .single();\r\n\r\n    if (error) {\r\n      console.error('Error fetching user stats:', error);\r\n      return null;\r\n    }\r\n\r\n    return data;\r\n  }\r\n\r\n  async updateUserStats(userId: string, updates: Partial<UserStats>): Promise<UserStats | null> {\r\n    const { data, error } = await supabase\r\n      .from('user_stats')\r\n      .update(updates)\r\n      .eq('user_id', userId)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      console.error('Error updating user stats:', error);\r\n      return null;\r\n    }\r\n\r\n    return data;\r\n  }\r\n\r\n  private async createUserStats(userId: string): Promise<UserStats | null> {\r\n    const statsData = {\r\n      user_id: userId,\r\n      verses_read: 0,\r\n      chapters_completed: 0,\r\n      devotionals_created: 0,\r\n      prayers_shared: 0,\r\n      friends_count: 0,\r\n      reading_time_minutes: 0,\r\n    };\r\n\r\n    const { data, error } = await supabase\r\n      .from('user_stats')\r\n      .insert(statsData)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      console.error('Error creating user stats:', error);\r\n      return null;\r\n    }\r\n\r\n    return data;\r\n  }\r\n\r\n  // Points and Level Management\r\n  async addPoints(userId: string, points: number): Promise<UserProfile | null> {\r\n    try {\r\n      // Get current user profile\r\n      const profile = await this.getUserProfile(userId);\r\n      if (!profile) {\r\n        console.error('User profile not found for userId:', userId);\r\n        return null;\r\n      }\r\n\r\n      // Calculate new points and level\r\n      const newPoints = profile.points + points;\r\n      const newLevel = Math.floor(newPoints / 1000) + 1;\r\n\r\n      // Update profile with better error handling\r\n      const { data, error } = await supabase\r\n        .from('users')\r\n        .update({\r\n          points: newPoints,\r\n          level: newLevel,\r\n          updated_at: new Date().toISOString()\r\n        })\r\n        .eq('id', userId)\r\n        .select()\r\n        .single();\r\n\r\n      if (error) {\r\n        console.error('Error updating user profile:', {\r\n          error: error,\r\n          message: error.message,\r\n          details: error.details,\r\n          hint: error.hint,\r\n          code: error.code,\r\n          userId: userId,\r\n          newPoints: newPoints,\r\n          newLevel: newLevel\r\n        });\r\n        return null;\r\n      }\r\n\r\n      return data;\r\n    } catch (err) {\r\n      console.error('Unexpected error in addPoints:', err);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  async updateStreak(userId: string, streak: number): Promise<UserProfile | null> {\r\n    const profile = await this.getUserProfile(userId);\r\n    if (!profile) return null;\r\n\r\n    // Update longest streak if current streak exceeds it\r\n    const newLongestStreak = Math.max(profile.longest_streak, streak);\r\n\r\n    return await this.updateUserProfile(userId, { \r\n      streak, \r\n      longest_streak: newLongestStreak \r\n    });\r\n  }\r\n\r\n  // Reading Progress\r\n  async updateReadingProgress(userId: string, book: string, chapter: number, versesRead: number = 1): Promise<UserStats | null> {\r\n    const stats = await this.getUserStats(userId);\r\n    if (!stats) return null;\r\n\r\n    return await this.updateUserStats(userId, {\r\n      verses_read: stats.verses_read + versesRead,\r\n      chapters_completed: stats.chapters_completed + (versesRead > 0 ? 1 : 0),\r\n    });\r\n  }\r\n\r\n  // Devotional Activities\r\n  async createDevotional(userId: string): Promise<UserStats | null> {\r\n    const stats = await this.getUserStats(userId);\r\n    if (!stats) return null;\r\n\r\n    return await this.updateUserStats(userId, {\r\n      devotionals_created: stats.devotionals_created + 1,\r\n    });\r\n  }\r\n\r\n  // Real Devotional Creation\r\n  async createDevotionalContent(userId: string, devotionalData: {\r\n    title: string;\r\n    content: string;\r\n    verse_reference?: string;\r\n    verse_text?: string;\r\n    author_name?: string;\r\n    tags?: string[];\r\n    is_public?: boolean;\r\n  }): Promise<any> {\r\n    try {\r\n      // Check if user is authenticated\r\n      const { data: authData } = await this.getClient().auth.getUser();\r\n      console.log('Auth check:', authData);\r\n      \r\n      if (!authData.user) {\r\n        console.error('User not authenticated');\r\n        return null;\r\n      }\r\n\r\n      console.log('Creating devotional with data:', {\r\n        userId,\r\n        devotionalData\r\n      });\r\n\r\n      const { data, error } = await this.getClient()\r\n        .from('devotionals')\r\n        .insert({\r\n          user_id: userId,\r\n          title: devotionalData.title,\r\n          content: devotionalData.content,\r\n          verse_reference: devotionalData.verse_reference,\r\n          verse_text: devotionalData.verse_text,\r\n          author_name: devotionalData.author_name || 'Anonymous',\r\n          tags: devotionalData.tags || [],\r\n          is_public: devotionalData.is_public !== false,\r\n        })\r\n        .select()\r\n        .single();\r\n\r\n      console.log('Supabase response:', { data, error });\r\n\r\n      if (error) {\r\n        console.error('Error creating devotional:', {\r\n          message: error.message,\r\n          details: error.details,\r\n          hint: error.hint,\r\n          code: error.code\r\n        });\r\n        return null;\r\n      }\r\n\r\n      // Award points for creating devotional\r\n      await this.addPoints(userId, 20); // 20 points for creating a devotional\r\n      await this.createDevotional(userId);\r\n\r\n      return data;\r\n    } catch (error) {\r\n      console.error('Error creating devotional (catch):', {\r\n        error: error,\r\n        message: error instanceof Error ? error.message : 'Unknown error',\r\n        stack: error instanceof Error ? error.stack : undefined\r\n      });\r\n      return null;\r\n    }\r\n  }\r\n\r\n  // Reading Plan Creation\r\n  async createReadingPlan(userId: string, planData: {\r\n    title: string;\r\n    description?: string;\r\n    duration: number;\r\n    difficulty?: 'beginner' | 'intermediate' | 'advanced';\r\n    category?: string;\r\n    verses_per_day?: number;\r\n    is_public?: boolean;\r\n  }): Promise<any> {\r\n    try {\r\n      const { data, error } = await this.getClient()\r\n        .from('reading_plans')\r\n        .insert({\r\n          user_id: userId,\r\n          title: planData.title,\r\n          description: planData.description,\r\n          duration: planData.duration,\r\n          difficulty: planData.difficulty || 'beginner',\r\n          category: planData.category,\r\n          verses_per_day: planData.verses_per_day || 3,\r\n          is_public: planData.is_public !== false,\r\n        })\r\n        .select()\r\n        .single();\r\n\r\n      if (error) {\r\n        console.error('Error creating reading plan:', error);\r\n        return null;\r\n      }\r\n\r\n      // Award points for creating reading plan\r\n      await this.addPoints(userId, 15); // 15 points for creating a reading plan\r\n\r\n      return data;\r\n    } catch (error) {\r\n      console.error('Error creating reading plan:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  // Start Reading Plan\r\n  async startReadingPlan(userId: string, planId: string): Promise<any> {\r\n    try {\r\n      const { data, error } = await this.getClient()\r\n        .from('user_reading_plans')\r\n        .insert({\r\n          user_id: userId,\r\n          plan_id: planId,\r\n          started_at: new Date().toISOString(),\r\n          current_day: 1,\r\n          is_active: true,\r\n        })\r\n        .select()\r\n        .single();\r\n\r\n      if (error) {\r\n        console.error('Error starting reading plan:', error);\r\n        return null;\r\n      }\r\n\r\n      // Award points for starting a reading plan\r\n      await this.addPoints(userId, 5); // 5 points for starting a plan\r\n\r\n      return data;\r\n    } catch (error) {\r\n      console.error('Error starting reading plan:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  // Prayer Activities\r\n  async sharePrayer(userId: string): Promise<UserStats | null> {\r\n    const stats = await this.getUserStats(userId);\r\n    if (!stats) return null;\r\n\r\n    return await this.updateUserStats(userId, {\r\n      prayers_shared: stats.prayers_shared + 1,\r\n    });\r\n  }\r\n\r\n  // Reading Time\r\n  async addReadingTime(userId: string, minutes: number): Promise<UserStats | null> {\r\n    const stats = await this.getUserStats(userId);\r\n    if (!stats) return null;\r\n\r\n    return await this.updateUserStats(userId, {\r\n      reading_time_minutes: stats.reading_time_minutes + minutes,\r\n    });\r\n  }\r\n\r\n  // User Achievements\r\n  async getUserAchievements(userId: string): Promise<UserAchievement[]> {\r\n    try {\r\n      // First get user achievements\r\n      const { data: userAchievements, error: userAchievementsError } = await this.getClient()\r\n        .from('user_achievements')\r\n        .select('*')\r\n        .eq('user_id', userId);\r\n\r\n      if (userAchievementsError) {\r\n        console.error('Error fetching user achievements:', userAchievementsError);\r\n        return [];\r\n      }\r\n\r\n      if (!userAchievements || userAchievements.length === 0) {\r\n        return [];\r\n      }\r\n\r\n      // Then get achievement details from local data\r\n      const { achievements } = await import('@/data/achievements');\r\n      const achievementIds = userAchievements.map((ua: any) => ua.achievement_id);\r\n      const achievementMap = new Map(achievements.map((a: any) => [a.id, a]));\r\n      \r\n      return userAchievements.map((ua: any) => ({\r\n        id: ua.id,\r\n        user_id: ua.user_id,\r\n        achievement_id: ua.achievement_id,\r\n        unlocked_at: ua.unlocked_at,\r\n        points_awarded: ua.points_awarded,\r\n        achievement: achievementMap.get(ua.achievement_id) || null,\r\n      }));\r\n    } catch (error) {\r\n      console.error('Error in getUserAchievements:', error);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  async unlockAchievement(userId: string, achievementId: string): Promise<boolean> {\r\n    try {\r\n      // Check if achievement is already unlocked\r\n      const { data: existing } = await this.getClient()\r\n        .from('user_achievements')\r\n        .select('id')\r\n        .eq('user_id', userId)\r\n        .eq('achievement_id', achievementId)\r\n        .maybeSingle();\r\n\r\n      if (existing) {\r\n        // Achievement already unlocked, no need to insert again\r\n        return true;\r\n      }\r\n\r\n      // Insert new achievement\r\n      const { error } = await this.getClient()\r\n        .from('user_achievements')\r\n        .insert({\r\n          user_id: userId,\r\n          achievement_id: achievementId,\r\n          unlocked_at: new Date().toISOString(),\r\n        });\r\n\r\n      if (error) {\r\n        console.error('Error unlocking achievement:', error);\r\n        return false;\r\n      }\r\n\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Error unlocking achievement:', error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  // Leaderboard methods\r\n  async getLeaderboard(limit: number = 50): Promise<UserProfile[]> {\r\n    try {\r\n      console.log('Fetching leaderboard data from optimized table...');\r\n      \r\n      const { data, error } = await supabase\r\n        .from('leaderboard_view')\r\n        .select('*')\r\n        .order('rank_position', { ascending: true })\r\n        .limit(limit);\r\n\r\n      console.log('Leaderboard query result:', { data, error, count: data?.length });\r\n\r\n      if (error) throw error;\r\n      \r\n      // Transform to UserProfile format\r\n      return data?.map(user => ({\r\n        id: user.user_id,\r\n        username: user.username,\r\n        email: user.email,\r\n        full_name: user.full_name,\r\n        avatar_url: user.avatar_url,\r\n        points: user.total_points,\r\n        level: user.level,\r\n        streak: user.streak,\r\n        longest_streak: user.longest_streak,\r\n        status: 'active' as const,\r\n        created_at: user.user_created_at,\r\n        updated_at: user.updated_at,\r\n      })) || [];\r\n    } catch (error) {\r\n      console.error('Error fetching leaderboard:', error);\r\n      // Fallback to original users table\r\n      return this.getLeaderboardFallback(limit);\r\n    }\r\n  }\r\n\r\n  private async getLeaderboardFallback(limit: number = 50): Promise<UserProfile[]> {\r\n    try {\r\n      console.log('Using fallback leaderboard query...');\r\n      \r\n      // First try with status filter, then fallback without it\r\n      let query = supabase.from('users').select('*');\r\n      \r\n      try {\r\n        query = query.eq('status', 'active');\r\n      } catch (statusError) {\r\n        console.log('Status column might not exist, skipping status filter');\r\n        // Continue without status filter\r\n      }\r\n      \r\n      const { data, error } = await query\r\n        .order('points', { ascending: false })\r\n        .limit(limit);\r\n      \r\n      console.log('Fallback leaderboard query result:', { data, error, count: data?.length });\r\n      \r\n      if (error) throw error;\r\n      return data || [];\r\n    } catch (fallbackError) {\r\n      console.error('Fallback query also failed:', fallbackError);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  async getWeeklyLeaderboard(limit: number = 50): Promise<UserProfile[]> {\r\n    try {\r\n      console.log('Fetching weekly leaderboard data from optimized table...');\r\n      \r\n      const { data, error } = await supabase\r\n        .from('leaderboard')\r\n        .select('*')\r\n        .order('weekly_points', { ascending: false })\r\n        .limit(limit);\r\n\r\n      console.log('Weekly leaderboard query result:', { data, error, count: data?.length });\r\n\r\n      if (error) throw error;\r\n      \r\n      // Transform to UserProfile format\r\n      return data?.map(user => ({\r\n        id: user.user_id,\r\n        username: user.username,\r\n        email: '',\r\n        full_name: '',\r\n        avatar_url: user.avatar_url,\r\n        points: user.weekly_points, // Use weekly points\r\n        level: user.level,\r\n        streak: user.streak,\r\n        longest_streak: user.longest_streak,\r\n        status: 'active' as const,\r\n        created_at: user.created_at,\r\n        updated_at: user.updated_at,\r\n      })) || [];\r\n    } catch (error) {\r\n      console.error('Error fetching weekly leaderboard:', error);\r\n      // Fallback to original method\r\n      return this.getWeeklyLeaderboardFallback(limit);\r\n    }\r\n  }\r\n\r\n  private async getWeeklyLeaderboardFallback(limit: number = 50): Promise<UserProfile[]> {\r\n    try {\r\n      console.log('Using fallback weekly leaderboard query...');\r\n      // Get users with their points from the last 7 days\r\n      const sevenDaysAgo = new Date();\r\n      sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);\r\n      \r\n      // First try with status filter, then fallback without it\r\n      let query = supabase\r\n        .from('users')\r\n        .select('*')\r\n        .gte('updated_at', sevenDaysAgo.toISOString());\r\n      \r\n      try {\r\n        query = query.eq('status', 'active');\r\n      } catch (statusError) {\r\n        console.log('Status column might not exist, skipping status filter for weekly leaderboard');\r\n        // Continue without status filter\r\n      }\r\n      \r\n      const { data, error } = await query\r\n        .order('points', { ascending: false })\r\n        .limit(limit);\r\n\r\n      console.log('Fallback weekly leaderboard query result:', { data, error, count: data?.length });\r\n\r\n      if (error) throw error;\r\n      return data || [];\r\n    } catch (fallbackError) {\r\n      console.error('Fallback weekly query also failed:', fallbackError);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  async getStreakLeaderboard(limit: number = 50): Promise<UserProfile[]> {\r\n    try {\r\n      console.log('Fetching streak leaderboard data from optimized table...');\r\n      \r\n      const { data, error } = await supabase\r\n        .from('leaderboard')\r\n        .select('*')\r\n        .order('streak', { ascending: false })\r\n        .limit(limit);\r\n\r\n      console.log('Streak leaderboard query result:', { data, error, count: data?.length });\r\n\r\n      if (error) throw error;\r\n      \r\n      // Transform to UserProfile format\r\n      return data?.map(user => ({\r\n        id: user.user_id,\r\n        username: user.username,\r\n        email: '',\r\n        full_name: '',\r\n        avatar_url: user.avatar_url,\r\n        points: user.total_points,\r\n        level: user.level,\r\n        streak: user.streak,\r\n        longest_streak: user.longest_streak,\r\n        status: 'active' as const,\r\n        created_at: user.created_at,\r\n        updated_at: user.updated_at,\r\n      })) || [];\r\n    } catch (error) {\r\n      console.error('Error fetching streak leaderboard:', error);\r\n      // Fallback to original method\r\n      return this.getStreakLeaderboardFallback(limit);\r\n    }\r\n  }\r\n\r\n  private async getStreakLeaderboardFallback(limit: number = 50): Promise<UserProfile[]> {\r\n    try {\r\n      console.log('Using fallback streak leaderboard query...');\r\n      \r\n      // First try with status filter, then fallback without it\r\n      let query = supabase.from('users').select('*');\r\n      \r\n      try {\r\n        query = query.eq('status', 'active');\r\n      } catch (statusError) {\r\n        console.log('Status column might not exist, skipping status filter for streak leaderboard');\r\n        // Continue without status filter\r\n      }\r\n      \r\n      const { data, error } = await query\r\n        .order('streak', { ascending: false })\r\n        .limit(limit);\r\n\r\n      console.log('Fallback streak leaderboard query result:', { data, error, count: data?.length });\r\n\r\n      if (error) throw error;\r\n      return data || [];\r\n    } catch (fallbackError) {\r\n      console.error('Fallback streak query also failed:', fallbackError);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  async getUserRank(userId: string): Promise<number> {\r\n    try {\r\n      // Try to get rank from optimized leaderboard table first\r\n      const { data: rankData, error: rankError } = await supabase\r\n        .from('leaderboard')\r\n        .select('rank_position')\r\n        .eq('user_id', userId)\r\n        .single();\r\n\r\n      if (!rankError && rankData) {\r\n        return rankData.rank_position;\r\n      }\r\n\r\n      // Fallback to calculating rank from users table\r\n      const { data: userData, error: userError } = await supabase\r\n        .from('users')\r\n        .select('points')\r\n        .eq('id', userId)\r\n        .single();\r\n\r\n      if (userError) throw userError;\r\n\r\n      const { count, error: rankError2 } = await supabase\r\n        .from('users')\r\n        .select('*', { count: 'exact', head: true })\r\n        .eq('status', 'active')\r\n        .gt('points', userData.points);\r\n\r\n      if (rankError2) throw rankError2;\r\n\r\n      return (count || 0) + 1;\r\n    } catch (error) {\r\n      console.error('Error fetching user rank:', error);\r\n      return 1;\r\n    }\r\n  }\r\n\r\n  // Real-time subscription methods for leaderboard\r\n  subscribeToLeaderboard(callback: (leaderboard: UserProfile[]) => void): RealtimeChannel {\r\n    const channelName = 'leaderboard_updates';\r\n    \r\n    if (this.channels.has(channelName)) {\r\n      return this.channels.get(channelName)!;\r\n    }\r\n\r\n    const channel = supabase\r\n      .channel(channelName)\r\n      .on(\r\n        'postgres_changes',\r\n        {\r\n          event: '*',\r\n          schema: 'public',\r\n          table: 'leaderboard',\r\n        },\r\n        async () => {\r\n          // Refresh leaderboard data when changes occur\r\n          const updatedLeaderboard = await this.getLeaderboard(50);\r\n          callback(updatedLeaderboard);\r\n        }\r\n      )\r\n      .subscribe();\r\n\r\n    this.channels.set(channelName, channel);\r\n    return channel;\r\n  }\r\n\r\n  subscribeToUserRanking(userId: string, callback: (ranking: any) => void): RealtimeChannel {\r\n    const channelName = `user_ranking_${userId}`;\r\n    \r\n    if (this.channels.has(channelName)) {\r\n      return this.channels.get(channelName)!;\r\n    }\r\n\r\n    const channel = supabase\r\n      .channel(channelName)\r\n      .on(\r\n        'postgres_changes',\r\n        {\r\n          event: '*',\r\n          schema: 'public',\r\n          table: 'leaderboard',\r\n          filter: `user_id=eq.${userId}`,\r\n        },\r\n        async (payload) => {\r\n          if (payload.eventType === 'UPDATE' && payload.new) {\r\n            callback(payload.new);\r\n          }\r\n        }\r\n      )\r\n      .subscribe();\r\n\r\n    this.channels.set(channelName, channel);\r\n    return channel;\r\n  }\r\n\r\n  // Realtime Subscriptions\r\n  subscribeToUser(userId: string, callback: (profile: UserProfile) => void): RealtimeChannel {\r\n    const channelName = `user_${userId}`;\r\n    \r\n    if (this.channels.has(channelName)) {\r\n      return this.channels.get(channelName)!;\r\n    }\r\n\r\n    const channel = supabase\r\n      .channel(channelName)\r\n      .on(\r\n        'postgres_changes',\r\n        {\r\n          event: '*',\r\n          schema: 'public',\r\n          table: 'users',\r\n          filter: `id=eq.${userId}`,\r\n        },\r\n        (payload) => {\r\n          if (payload.eventType === 'UPDATE' && payload.new) {\r\n            callback(payload.new as UserProfile);\r\n          }\r\n        }\r\n      )\r\n      .subscribe();\r\n\r\n    this.channels.set(channelName, channel);\r\n    return channel;\r\n  }\r\n\r\n  subscribeToUserStats(userId: string, callback: (stats: UserStats) => void): RealtimeChannel {\r\n    const channelName = `user_stats_${userId}`;\r\n    \r\n    if (this.channels.has(channelName)) {\r\n      return this.channels.get(channelName)!;\r\n    }\r\n\r\n    const channel = supabase\r\n      .channel(channelName)\r\n      .on(\r\n        'postgres_changes',\r\n        {\r\n          event: '*',\r\n          schema: 'public',\r\n          table: 'user_stats',\r\n          filter: `user_id=eq.${userId}`,\r\n        },\r\n        (payload) => {\r\n          if (payload.eventType === 'UPDATE' && payload.new) {\r\n            callback(payload.new as UserStats);\r\n          }\r\n        }\r\n      )\r\n      .subscribe();\r\n\r\n    this.channels.set(channelName, channel);\r\n    return channel;\r\n  }\r\n\r\n  // Cleanup\r\n  unsubscribe(channelName: string): void {\r\n    const channel = this.channels.get(channelName);\r\n    if (channel) {\r\n      supabase.removeChannel(channel);\r\n      this.channels.delete(channelName);\r\n    }\r\n  }\r\n\r\n  unsubscribeAll(): void {\r\n    this.channels.forEach((channel: any) => {\r\n      supabase.removeChannel(channel);\r\n    });\r\n    this.channels.clear();\r\n  }\r\n}\r\n\r\nexport const supabaseService = new SupabaseService();\r\n","import { supabase } from '@/lib/supabase';\r\nimport { supabaseService } from './supabaseService';\r\n\r\nexport interface ReferralInfo {\r\n  referral_code: string;\r\n  referral_url: string;\r\n  total_referrals: number;\r\n  completed_referrals: number;\r\n  pending_referrals: number;\r\n  points_earned: number;\r\n}\r\n\r\nexport class ReferralService {\r\n  static async getReferralInfo(userId: string): Promise<ReferralInfo | null> {\r\n    try {\r\n      console.log('Getting referral info for userId:', userId);\r\n      \r\n      // Try to get username and referral_code, fallback to email if username doesn't exist\r\n      const { data: user, error: userError } = await supabase\r\n        .from('users')\r\n        .select('username, referral_code, email')\r\n        .eq('id', userId)\r\n        .single();\r\n\r\n      console.log('User data:', user);\r\n      console.log('User error:', userError);\r\n\r\n      if (userError) {\r\n        console.error('Error fetching user:', userError);\r\n        console.error('Error details:', JSON.stringify(userError, null, 2));\r\n        console.error('Error code:', userError.code);\r\n        console.error('Error message:', userError.message);\r\n        console.error('Error details:', userError.details);\r\n        \r\n        // If user doesn't exist, try to get their email from auth and create a basic referral code\r\n        const { data: authUser } = await supabase.auth.getUser();\r\n        if (authUser.user && authUser.user.email) {\r\n          const emailReferralCode = authUser.user.email.split('@')[0].toLowerCase().replace(/[^a-zA-Z0-9]/g, '');\r\n          console.log('Using auth email for referral code:', emailReferralCode);\r\n          \r\n          return {\r\n            referral_code: emailReferralCode,\r\n            referral_url: `${window.location.origin}/auth?ref=${emailReferralCode}`,\r\n            total_referrals: 0,\r\n            completed_referrals: 0,\r\n            pending_referrals: 0,\r\n            points_earned: 0\r\n          };\r\n        }\r\n        \r\n        return null;\r\n      }\r\n\r\n      if (!user) {\r\n        console.log('No user data found');\r\n        return null;\r\n      }\r\n\r\n      // Use username as referral code if referral_code is not set, fallback to email\r\n      const referralCode = user.referral_code || user.username || user.email.split('@')[0].toLowerCase();\r\n      console.log('Using referral code:', referralCode);\r\n\r\n      const { data: referrals, error: referralError } = await supabase\r\n        .from('referrals')\r\n        .select('status, points_awarded')\r\n        .eq('referrer_id', userId);\r\n\r\n      console.log('Referrals data:', referrals);\r\n      console.log('Referrals error:', referralError);\r\n\r\n      if (referralError) {\r\n        console.error('Error fetching referrals:', referralError);\r\n        // Return basic info if referrals table doesn't exist or has permission issues\r\n        return {\r\n          referral_code: referralCode,\r\n          referral_url: `${window.location.origin}/auth?ref=${referralCode}`,\r\n          total_referrals: 0,\r\n          completed_referrals: 0,\r\n          pending_referrals: 0,\r\n          points_earned: 0\r\n        };\r\n      }\r\n\r\n      const referralList = referrals || [];\r\n      const completed_referrals = referralList.filter(r => r.status === 'completed').length;\r\n      const pending_referrals = referralList.filter(r => r.status === 'pending').length;\r\n      const points_earned = referralList.reduce((sum, r) => sum + (r.points_awarded || 0), 0);\r\n\r\n      return {\r\n        referral_code: referralCode,\r\n        referral_url: `${window.location.origin}/auth?ref=${referralCode}`,\r\n        total_referrals: referralList.length,\r\n        completed_referrals,\r\n        pending_referrals,\r\n        points_earned\r\n      };\r\n    } catch (error) {\r\n      console.error('Error getting referral info:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  static async processReferral(referralCode: string, newUserId: string): Promise<boolean> {\r\n    try {\r\n      const { data: referrer, error: referrerError } = await supabase\r\n        .from('users')\r\n        .select('id')\r\n        .eq('referral_code', referralCode)\r\n        .single();\r\n\r\n      if (referrerError || !referrer) return false;\r\n\r\n      const { data: existingReferral } = await supabase\r\n        .from('referrals')\r\n        .select('id')\r\n        .eq('referred_id', newUserId)\r\n        .single();\r\n\r\n      if (existingReferral) return false;\r\n\r\n      await supabase\r\n        .from('users')\r\n        .update({ referred_by: referrer.id })\r\n        .eq('id', newUserId);\r\n\r\n      const { error: referralError } = await supabase\r\n        .from('referrals')\r\n        .insert({\r\n          referrer_id: referrer.id,\r\n          referred_id: newUserId,\r\n          referral_code: referralCode,\r\n          status: 'pending',\r\n          points_awarded: 0\r\n        });\r\n\r\n      if (referralError) throw referralError;\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Error processing referral:', error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  static async completeReferral(referralId: string): Promise<void> {\r\n    try {\r\n      const { data: referral, error: fetchError } = await supabase\r\n        .from('referrals')\r\n        .select('*')\r\n        .eq('id', referralId)\r\n        .single();\r\n\r\n      if (fetchError || !referral) throw fetchError;\r\n\r\n      const { error: updateError } = await supabase\r\n        .from('referrals')\r\n        .update({\r\n          status: 'completed',\r\n          points_awarded: 100,\r\n          completed_at: new Date().toISOString()\r\n        })\r\n        .eq('id', referralId);\r\n\r\n      if (updateError) throw updateError;\r\n\r\n      await supabaseService.addPoints(referral.referrer_id, 100);\r\n\r\n      await supabase\r\n        .from('points_transactions')\r\n        .insert({\r\n          user_id: referral.referrer_id,\r\n          transaction_type: 'referral',\r\n          points: 100,\r\n          description: 'Referral bonus',\r\n          metadata: {\r\n            referred_user: referral.referred_id,\r\n            referral_code: referral.referral_code\r\n          }\r\n        });\r\n\r\n      await supabase\r\n        .from('user_stats')\r\n        .update({\r\n          referrals_completed: supabase.rpc('increment', { amount: 1 }),\r\n          total_points_earned: supabase.rpc('increment', { amount: 100 })\r\n        })\r\n        .eq('user_id', referral.referrer_id);\r\n\r\n      await supabaseService.addPoints(referral.referred_id, 50);\r\n\r\n      await supabase\r\n        .from('points_transactions')\r\n        .insert({\r\n          user_id: referral.referred_id,\r\n          transaction_type: 'referral',\r\n          points: 50,\r\n          description: 'Welcome bonus',\r\n          metadata: {\r\n            referred_by: referral.referrer_id,\r\n            referral_code: referral.referral_code\r\n          }\r\n        });\r\n\r\n      await supabase\r\n        .from('user_stats')\r\n        .update({\r\n          total_points_earned: supabase.rpc('increment', { amount: 50 })\r\n        })\r\n        .eq('user_id', referral.referred_id);\r\n    } catch (error) {\r\n      console.error('Error completing referral:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  static generateReferralUrl(referralCode: string): string {\r\n    return `${window.location.origin}/auth?ref=${referralCode}`;\r\n  }\r\n\r\n  static async validateReferralCode(referralCode: string): Promise<boolean> {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('users')\r\n        .select('id')\r\n        .eq('referral_code', referralCode)\r\n        .single();\r\n\r\n      return !error && !!data;\r\n    } catch (error) {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  static async getReferralHistory(userId: string): Promise<any[]> {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('referrals')\r\n        .select(`\r\n          *,\r\n          referred_user:referred_id(id, username, email, created_at)\r\n        `)\r\n        .eq('referrer_id', userId)\r\n        .order('created_at', { ascending: false });\r\n\r\n      if (error) throw error;\r\n      return data || [];\r\n    } catch (error) {\r\n      console.error('Error getting referral history:', error);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  static async checkPendingReferrals(userId: string): Promise<void> {\r\n    try {\r\n      const userProfile = await supabaseService.getUserProfile(userId);\r\n      if (!userProfile) return;\r\n\r\n      const isActive = userProfile.points > 0 || userProfile.streak > 0;\r\n      \r\n      if (isActive) {\r\n        const { data: pendingReferrals } = await supabase\r\n          .from('referrals')\r\n          .select('id')\r\n          .eq('referred_id', userId)\r\n          .eq('status', 'pending');\r\n\r\n        if (pendingReferrals && pendingReferrals.length > 0) {\r\n          await this.completeReferral(pendingReferrals[0].id);\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error('Error checking pending referrals:', error);\r\n    }\r\n  }\r\n}\r\n\r\nexport const referralService = ReferralService;\r\n"],"names":[],"mappings":"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"}