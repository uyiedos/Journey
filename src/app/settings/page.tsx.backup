'use client';

import React, { useState, useEffect } from 'react';
import { Layout } from '@/components/layout/Layout';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Switch } from '@/components/ui/switch';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Separator } from '@/components/ui/separator';
import { Badge } from '@/components/ui/badge';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { 
  Settings, 
  Moon, 
  Sun, 
  Monitor, 
  Bell, 
  Mail, 
  MessageSquare, 
  Heart, 
  Trophy, 
  BookOpen, 
  Users, 
  Eye, 
  EyeOff, 
  User, 
  Lock, 
  Smartphone,
  Volume2,
  VolumeX,
  Camera,
  Upload,
  Gift,
  Copy,
  CheckCircle
} from 'lucide-react';

import { useUserData } from '@/contexts/UserDataContext';
import { useAuth } from '@/contexts/SupabaseAuthContext';
import { referralService } from '@/services/referralService';
import { supabase } from '@/lib/supabase';
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';
import { Alert, AlertDescription } from '@/components/ui/alert';

// Force dynamic rendering
export const dynamic = 'force-dynamic';

export default function SettingsPage() {
  const { user, updateSettings } = useUserData();
  const { user: authUser } = useAuth();
  
  // Account state
  const [referralInfo, setReferralInfo] = useState<any>(null);
  const [copied, setCopied] = useState(false);
  const [loadingReferral, setLoadingReferral] = useState(false);
  const [uploadingImage, setUploadingImage] = useState(false);
  const [accountForm, setAccountForm] = useState({
    username: '',
    fullName: '',
  });
  const [saving, setSaving] = useState(false);
  
  // Return loading state if user data is not available
  if (!user) {
    return (
      <Layout>
        <div className="flex items-center justify-center min-h-screen">
          <div className="text-center">
            <Settings className="h-16 w-16 mx-auto mb-4 text-muted-foreground animate-pulse" />
            <h2 className="text-xl font-semibold mb-2">Loading Settings...</h2>
            <p className="text-muted-foreground">Please wait while we load your settings.</p>
          </div>
        </div>
      </Layout>
    );
  }
  
  // Initialize settings from user data
  const [theme, setTheme] = useState<'light' | 'dark' | 'system'>((user.settings.theme as 'light' | 'dark' | 'system') || 'system');
  const [notifications, setNotifications] = useState(user.settings.notifications || {
    email: true,
    push: true,
    dailyDevotional: true,
    friendRequests: true,
    messages: true,
    achievementAlerts: true,
    communityPosts: false,
    readingReminders: true,
    weeklyProgress: true,
  });
  const [privacy, setPrivacy] = useState(user.settings.privacy || {
    profileVisibility: 'public',
    showOnlineStatus: true,
    showReadingProgress: true,
    allowFriendRequests: true,
    showAchievements: true,
  });
  const [reading, setReading] = useState(user.settings.reading || {
    fontSize: 'medium',
    translation: 'kjv',
    dailyReminderTime: '08:00',
    autoPlayAudio: false,
    highlightVerses: true,
    showNotes: true,
  });
  const [soundEnabled, setSoundEnabled] = useState(true);

  // Apply theme changes
  useEffect(() => {
    const root = window.document.documentElement;
    root.classList.remove('light', 'dark');
    
    if (theme === 'system') {
      const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      root.classList.add(systemTheme);
    } else {
      root.classList.add(theme);
    }
  }, [theme]);

  // Initialize account form
  useEffect(() => {
    if (user) {
      setAccountForm({
        username: user.username || '',
        fullName: user.fullName || '',
      });
    }
  }, [user]);

  const loadReferralInfo = async () => {
    if (!authUser) return;
    
    try {
      setLoadingReferral(true);
      const info = await referralService.getReferralInfo(authUser.id);
      setReferralInfo(info);
    } catch (error) {
      console.error('Error loading referral info:', error);
    } finally {
      setLoadingReferral(false);
    }
  };

  const copyReferralLink = async () => {
    if (referralInfo?.referral_url) {
      try {
        await navigator.clipboard.writeText(referralInfo.referral_url);
        setCopied(true);
        setTimeout(() => setCopied(false), 2000);
      } catch (error) {
        console.error('Error copying link:', error);
      }
    }
  };

  const handleImageUpload = async (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (!file || !authUser) return;

    try {
      setUploadingImage(true);
      
      // Upload to Supabase Storage
      const fileExt = file.name.split('.').pop();
      const fileName = `${authUser.id}-${Date.now()}.${fileExt}`;
      const filePath = `avatars/${fileName}`;

      const { error: uploadError } = await supabase.storage
        .from('avatars')
        .upload(filePath, file, { upsert: true });

      if (uploadError) throw uploadError;

      // Get public URL
      const { data: { publicUrl } } = supabase.storage
        .from('avatars')
        .getPublicUrl(filePath);

      // Update user profile
      const { error: updateError } = await supabase
        .from('users')
        .update({ avatar: publicUrl })
        .eq('id', authUser.id);

      if (updateError) throw updateError;

      // Update local state
      updateSettings({ avatar: publicUrl });
    } catch (error) {
      console.error('Error uploading image:', error);
    } finally {
      setUploadingImage(false);
    }
  };

  const handleAccountUpdate = async () => {
    if (!authUser) return;

    try {
      setSaving(true);
      
      const { error } = await supabase
        .from('users')
        .update({
          username: accountForm.username,
          full_name: accountForm.fullName,
        })
        .eq('id', authUser.id);

      if (error) throw error;

      // Update local state
      updateSettings({
        username: accountForm.username,
        fullName: accountForm.fullName,
      });
    } catch (error) {
      console.error('Error updating account:', error);
    } finally {
      setSaving(false);
    }
  };

  // Load referral info on mount
  useEffect(() => {
    loadReferralInfo();
  }, [authUser]);

  const handleNotificationChange = (key: string, value: boolean) => {
    setNotifications(prev => ({ ...prev, [key]: value }));
  };

  const handlePrivacyChange = (key: string, value: string | boolean) => {
    setPrivacy(prev => ({ ...prev, [key]: value }));
  };

  const handleReadingChange = (key: string, value: string | boolean) => {
    setReading(prev => ({ ...prev, [key]: value }));
  };

  const getThemeIcon = (themeValue: string) => {
    switch (themeValue) {
      case 'light': return <Sun className="h-4 w-4" />;
      case 'dark': return <Moon className="h-4 w-4" />;
      case 'system': return <Monitor className="h-4 w-4" />;
      default: return <Monitor className="h-4 w-4" />;
    }
  };

  return (
    <Layout>
      <div className="max-w-4xl mx-auto space-y-6">
        {/* Header */}
        <div className="flex items-center space-x-3">
          <Settings className="h-8 w-8 text-muted-foreground" />
          <div>
            <h1 className="text-3xl font-bold">Settings</h1>
            <p className="text-muted-foreground">
              Manage your account preferences and app settings
            </p>
          </div>
        </div>

        <Tabs defaultValue="general" className="space-y-6">
          <TabsList className="grid w-full grid-cols-5">
            <TabsTrigger value="general">General</TabsTrigger>
            <TabsTrigger value="notifications">Notifications</TabsTrigger>
            <TabsTrigger value="privacy">Privacy</TabsTrigger>
            <TabsTrigger value="reading">Reading</TabsTrigger>
            <TabsTrigger value="account">Account</TabsTrigger>
          </TabsList>

          {/* General Settings */}
          <TabsContent value="general" className="space-y-6">
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center space-x-2">
                  <Monitor className="h-5 w-5" />
                  <span>Appearance</span>
                </CardTitle>
                <CardDescription>
                  Customize how the app looks and feels
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="flex items-center justify-between">
                  <div className="space-y-1">
                    <Label>Theme</Label>
                    <p className="text-sm text-muted-foreground">
                      Choose your preferred color scheme
                    </p>
                  </div>
                  <Select value={theme} onValueChange={(value: 'light' | 'dark' | 'system') => setTheme(value)}>
                    <SelectTrigger className="w-40">
                      <div className="flex items-center space-x-2">
                        {getThemeIcon(theme)}
                        <SelectValue />
                      </div>
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="light">
                        <div className="flex items-center space-x-2">
                          <Sun className="h-4 w-4" />
                          <span>Light</span>
                        </div>
                      </SelectItem>
                      <SelectItem value="dark">
                        <div className="flex items-center space-x-2">
                          <Moon className="h-4 w-4" />
                          <span>Dark</span>
                        </div>
                      </SelectItem>
                      <SelectItem value="system">
                        <div className="flex items-center space-x-2">
                          <Monitor className="h-4 w-4" />
                          <span>System</span>
                        </div>
                      </SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <Separator />

                <div className="flex items-center justify-between">
                  <div className="space-y-1">
                    <Label>Sound Effects</Label>
                    <p className="text-sm text-muted-foreground">
                      Play sounds for notifications and interactions
                    </p>
                  </div>
                  <div className="flex items-center space-x-2">
                    {soundEnabled ? (
                      <Volume2 className="h-4 w-4 text-muted-foreground" />
                    ) : (
                      <VolumeX className="h-4 w-4 text-muted-foreground" />
                    )}
                    <Switch
                      checked={soundEnabled}
                      onCheckedChange={setSoundEnabled}
                    />
                  </div>
                </div>
              </CardContent>
            </Card>

            <Card>
              <CardHeader>
                <CardTitle>Language & Region</CardTitle>
                <CardDescription>
                  Set your language and regional preferences
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className="space-y-2">
                    <Label>Language</Label>
                    <Select defaultValue="en">
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="en">English</SelectItem>
                        <SelectItem value="es">Español</SelectItem>
                        <SelectItem value="fr">Français</SelectItem>
                        <SelectItem value="de">Deutsch</SelectItem>
                        <SelectItem value="pt">Português</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>
                  <div className="space-y-2">
                    <Label>Time Zone</Label>
                    <Select defaultValue="utc-8">
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="utc-8">Pacific Time (UTC-8)</SelectItem>
                        <SelectItem value="utc-5">Eastern Time (UTC-5)</SelectItem>
                        <SelectItem value="utc+0">GMT (UTC+0)</SelectItem>
                        <SelectItem value="utc+1">Central European (UTC+1)</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>
                </div>
              </CardContent>
            </Card>
          </TabsContent>

          {/* Notifications */}
          <TabsContent value="notifications" className="space-y-6">
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center space-x-2">
                  <Bell className="h-5 w-5" />
                  <span>Notification Preferences</span>
                </CardTitle>
                <CardDescription>
                  Choose what notifications you want to receive
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-6">
                <div className="space-y-4">
                  <div className="flex items-center justify-between">
                    <div className="space-y-1">
                      <Label className="flex items-center space-x-2">
                        <Mail className="h-4 w-4" />
                        <span>Email Notifications</span>
                      </Label>
                      <p className="text-sm text-muted-foreground">
                        Receive notifications via email
                      </p>
                    </div>
                    <Switch
                      checked={notifications.email}
                      onCheckedChange={(checked) => handleNotificationChange('email', checked)}
                    />
                  </div>

                  <div className="flex items-center justify-between">
                    <div className="space-y-1">
                      <Label className="flex items-center space-x-2">
                        <Smartphone className="h-4 w-4" />
                        <span>Push Notifications</span>
                      </Label>
                      <p className="text-sm text-muted-foreground">
                        Receive push notifications on your device
                      </p>
                    </div>
                    <Switch
                      checked={notifications.push}
                      onCheckedChange={(checked) => handleNotificationChange('push', checked)}
                    />
                  </div>
                </div>

                <Separator />

                <div className="space-y-4">
                  <h4 className="text-sm font-medium">Notification Types</h4>
                  
                  <div className="flex items-center justify-between">
                    <div className="space-y-1">
                      <Label className="flex items-center space-x-2">
                        <BookOpen className="h-4 w-4" />
                        <span>Daily Devotional</span>
                      </Label>
                      <p className="text-sm text-muted-foreground">
                        Get notified when new devotionals are available
                      </p>
                    </div>
                    <Switch
                      checked={notifications.dailyDevotional}
                      onCheckedChange={(checked) => handleNotificationChange('dailyDevotional', checked)}
                    />
                  </div>

                  <div className="flex items-center justify-between">
                    <div className="space-y-1">
                      <Label className="flex items-center space-x-2">
                        <Users className="h-4 w-4" />
                        <span>Friend Requests</span>
                      </Label>
                      <p className="text-sm text-muted-foreground">
                        When someone sends you a friend request
                      </p>
                    </div>
                    <Switch
                      checked={notifications.friendRequests}
                      onCheckedChange={(checked) => handleNotificationChange('friendRequests', checked)}
                    />
                  </div>

                  <div className="flex items-center justify-between">
                    <div className="space-y-1">
                      <Label className="flex items-center space-x-2">
                        <MessageSquare className="h-4 w-4" />
                        <span>Messages</span>
                      </Label>
                      <p className="text-sm text-muted-foreground">
                        When someone sends you a message
                      </p>
                    </div>
                    <Switch
                      checked={notifications.messages}
                      onCheckedChange={(checked) => handleNotificationChange('messages', checked)}
                    />
                  </div>

                  <div className="flex items-center justify-between">
                    <div className="space-y-1">
                      <Label className="flex items-center space-x-2">
                        <Trophy className="h-4 w-4" />
                        <span>Achievement Alerts</span>
                      </Label>
                      <p className="text-sm text-muted-foreground">
                        When you unlock new achievements
                      </p>
                    </div>
                    <Switch
                      checked={notifications.achievementAlerts}
                      onCheckedChange={(checked) => handleNotificationChange('achievementAlerts', checked)}
                    />
                  </div>

                  <div className="flex items-center justify-between">
                    <div className="space-y-1">
                      <Label className="flex items-center space-x-2">
                        <Heart className="h-4 w-4" />
                        <span>Community Posts</span>
                      </Label>
                      <p className="text-sm text-muted-foreground">
                        When friends post in the community
                      </p>
                    </div>
                    <Switch
                      checked={notifications.communityPosts}
                      onCheckedChange={(checked) => handleNotificationChange('communityPosts', checked)}
                    />
                  </div>

                  <div className="flex items-center justify-between">
                    <div className="space-y-1">
                      <Label>Reading Reminders</Label>
                      <p className="text-sm text-muted-foreground">
                        Daily reminders to read your Bible
                      </p>
                    </div>
                    <Switch
                      checked={notifications.readingReminders}
                      onCheckedChange={(checked) => handleNotificationChange('readingReminders', checked)}
                    />
                  </div>

                  <div className="flex items-center justify-between">
                    <div className="space-y-1">
                      <Label>Weekly Progress</Label>
                      <p className="text-sm text-muted-foreground">
                        Weekly summary of your reading progress
                      </p>
                    </div>
                    <Switch
                      checked={notifications.weeklyProgress}
                      onCheckedChange={(checked) => handleNotificationChange('weeklyProgress', checked)}
                    />
                  </div>
                </div>
              </CardContent>
            </Card>
          </TabsContent>

          {/* Privacy */}
          <TabsContent value="privacy" className="space-y-6">
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center space-x-2">
                  <Eye className="h-5 w-5" />
                  <span>Privacy Settings</span>
                </CardTitle>
                <CardDescription>
                  Control your privacy and what others can see
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-6">
                <div className="space-y-4">
                  <div className="flex items-center justify-between">
                    <div className="space-y-1">
                      <Label>Profile Visibility</Label>
                      <p className="text-sm text-muted-foreground">
                        Who can see your profile
                      </p>
                    </div>
                    <Select 
                      value={privacy.profileVisibility} 
                      onValueChange={(value) => handlePrivacyChange('profileVisibility', value)}
                    >
                      <SelectTrigger className="w-32">
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="public">Public</SelectItem>
                        <SelectItem value="friends">Friends</SelectItem>
                        <SelectItem value="private">Private</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>

                  <div className="flex items-center justify-between">
                    <div className="space-y-1">
                      <Label className="flex items-center space-x-2">
                        <Eye className="h-4 w-4" />
                        <span>Show Online Status</span>
                      </Label>
                      <p className="text-sm text-muted-foreground">
                        Let others see when you're online
                      </p>
                    </div>
                    <Switch
                      checked={privacy.showOnlineStatus}
                      onCheckedChange={(checked) => handlePrivacyChange('showOnlineStatus', checked)}
                    />
                  </div>

                  <div className="flex items-center justify-between">
                    <div className="space-y-1">
                      <Label className="flex items-center space-x-2">
                        <BookOpen className="h-4 w-4" />
                        <span>Show Reading Progress</span>
                      </Label>
                      <p className="text-sm text-muted-foreground">
                        Display your reading progress on your profile
                      </p>
                    </div>
                    <Switch
                      checked={privacy.showReadingProgress}
                      onCheckedChange={(checked) => handlePrivacyChange('showReadingProgress', checked)}
                    />
                  </div>

                  <div className="flex items-center justify-between">
                    <div className="space-y-1">
                      <Label className="flex items-center space-x-2">
                        <Users className="h-4 w-4" />
                        <span>Allow Friend Requests</span>
                      </Label>
                      <p className="text-sm text-muted-foreground">
                        Let others send you friend requests
                      </p>
                    </div>
                    <Switch
                      checked={privacy.allowFriendRequests}
                      onCheckedChange={(checked) => handlePrivacyChange('allowFriendRequests', checked)}
                    />
                  </div>

                  <div className="flex items-center justify-between">
                    <div className="space-y-1">
                      <Label className="flex items-center space-x-2">
                        <Trophy className="h-4 w-4" />
                        <span>Show Achievements</span>
                      </Label>
                      <p className="text-sm text-muted-foreground">
                        Display your achievements on your profile
                      </p>
                    </div>
                    <Switch
                      checked={privacy.showAchievements}
                      onCheckedChange={(checked) => handlePrivacyChange('showAchievements', checked)}
                    />
                  </div>
                </div>
              </CardContent>
            </Card>

            <Card>
              <CardHeader>
                <CardTitle className="flex items-center space-x-2">
                  <Lock className="h-5 w-5" />
                  <span>Blocked Users</span>
                </CardTitle>
                <CardDescription>
                  Manage users you've blocked
                </CardDescription>
              </CardHeader>
              <CardContent>
                <div className="text-center py-8">
                  <Users className="h-12 w-12 mx-auto mb-4 text-muted-foreground" />
                  <h3 className="text-lg font-semibold mb-2">No blocked users</h3>
                  <p className="text-muted-foreground">
                    You haven't blocked any users yet
                  </p>
                </div>
              </CardContent>
            </Card>
          </TabsContent>

          {/* Reading */}
          <TabsContent value="reading" className="space-y-6">
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center space-x-2">
                  <BookOpen className="h-5 w-5" />
                  <span>Reading Preferences</span>
                </CardTitle>
                <CardDescription>
                  Customize your Bible reading experience
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-6">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className="space-y-2">
                    <Label>Font Size</Label>
                    <Select 
                      value={reading.fontSize} 
                      onValueChange={(value) => handleReadingChange('fontSize', value)}
                    >
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="small">Small</SelectItem>
                        <SelectItem value="medium">Medium</SelectItem>
                        <SelectItem value="large">Large</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>

                  <div className="space-y-2">
                    <Label>Bible Translation</Label>
                    <Select 
                      value={reading.translation} 
                      onValueChange={(value) => handleReadingChange('translation', value)}
                    >
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="kjv">King James Version (KJV)</SelectItem>
                        <SelectItem value="niv">New International Version (NIV)</SelectItem>
                        <SelectItem value="esv">English Standard Version (ESV)</SelectItem>
                        <SelectItem value="nlt">New Living Translation (NLT)</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>
                </div>

                <div className="space-y-2">
                  <Label>Daily Reminder Time</Label>
                  <Input
                    type="time"
                    value={reading.dailyReminderTime}
                    onChange={(e) => handleReadingChange('dailyReminderTime', e.target.value)}
                    className="w-32"
                  />
                </div>

                <Separator />

                <div className="space-y-4">
                  <div className="flex items-center justify-between">
                    <div className="space-y-1">
                      <Label>Auto-play Audio</Label>
                      <p className="text-sm text-muted-foreground">
                        Automatically play audio Bible when available
                      </p>
                    </div>
                    <Switch
                      checked={reading.autoPlayAudio}
                      onCheckedChange={(checked) => handleReadingChange('autoPlayAudio', checked)}
                    />
                  </div>

                  <div className="flex items-center justify-between">
                    <div className="space-y-1">
                      <Label>Highlight Verses</Label>
                      <p className="text-sm text-muted-foreground">
                        Highlight verses as you read
                      </p>
                    </div>
                    <Switch
                      checked={reading.highlightVerses}
                      onCheckedChange={(checked) => handleReadingChange('highlightVerses', checked)}
                    />
                  </div>

                  <div className="flex items-center justify-between">
                    <div className="space-y-1">
                      <Label>Show Notes</Label>
                      <p className="text-sm text-muted-foreground">
                        Display study notes and commentary
                      </p>
                    </div>
                    <Switch
                      checked={reading.showNotes}
                      onCheckedChange={(checked) => handleReadingChange('showNotes', checked)}
                    />
                  </div>
                </div>
              </CardContent>
            </Card>
          </TabsContent>

          {/* Account */}
          <TabsContent value="account" className="space-y-6">
            {/* Profile */}
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center space-x-2">
                  <User className="h-5 w-5" />
                  <span>Profile Information</span>
                </CardTitle>
                <CardDescription>
                  Manage your account details and profile
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-6">
                {/* Profile Image */}
                <div className="flex items-center space-x-4">
                  <div className="relative">
                    <Avatar className="h-20 w-20">
                      <AvatarImage src={user.avatar} alt={user.username} />
                      <AvatarFallback className="text-lg">
                        {user.username?.charAt(0)?.toUpperCase() || 'U'}
                      </AvatarFallback>
                    </Avatar>
                    <label htmlFor="avatar-upload" className="absolute bottom-0 right-0 bg-primary text-white rounded-full p-1 cursor-pointer hover:bg-primary/90">
                      {uploadingImage ? (
                        <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin" />
                      ) : (
                        <Camera className="h-4 w-4" />
                      )}
                    </label>
                    <input
                      id="avatar-upload"
                      type="file"
                      accept="image/*"
                      onChange={handleImageUpload}
                      className="hidden"
                      disabled={uploadingImage}
                    />
                  </div>
                  <div>
                    <h3 className="font-semibold">{user.username || 'No username'}</h3>
                    <p className="text-sm text-muted-foreground">{authUser?.email}</p>
                    <p className="text-xs text-muted-foreground">Member since {new Date(user.joinedAt).toLocaleDateString()}</p>
                  </div>
                </div>

                <Separator />

                {/* Account Details */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className="space-y-2">
                    <Label>Username</Label>
                    <Input
                      value={accountForm.username}
                      onChange={(e) => setAccountForm(prev => ({ ...prev, username: e.target.value }))}
                      placeholder="Enter username"
                    />
                  </div>
                  <div className="space-y-2">
                    <Label>Full Name</Label>
                    <Input
                      value={accountForm.fullName}
                      onChange={(e) => setAccountForm(prev => ({ ...prev, fullName: e.target.value }))}
                      placeholder="Enter full name"
                    />
                  </div>
                </div>

                <div className="space-y-2">
                  <Label>Email</Label>
                  <Input type="email" value={authUser?.email || ''} disabled className="bg-muted" />
                  <p className="text-xs text-muted-foreground">Email cannot be changed here. Contact support if needed.</p>
                </div>

                <Button onClick={handleAccountUpdate} disabled={saving}>
                  {saving ? (
                    <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2" />
                  ) : null}
                  Save Changes
                </Button>
              </CardContent>
            </Card>

            {/* Referral Information */}
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center space-x-2">
                  <Gift className="h-5 w-5" />
                  <span>Referral Program</span>
                </CardTitle>
                <CardDescription>
                  Share your referral link and earn rewards
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                {loadingReferral ? (
                  <div className="flex items-center justify-center py-8">
                    <div className="w-8 h-8 border-4 border-primary border-t-transparent rounded-full animate-spin" />
                  </div>
                ) : referralInfo ? (
                  <div className="space-y-4">
                    <div className="flex space-x-2">
                      <Input
                        value={referralInfo.referral_url}
                        readOnly
                        className="font-mono"
                      />
                      <Button
                        onClick={copyReferralLink}
                        variant="outline"
                        size="sm"
                      >
                        {copied ? (
                          <CheckCircle className="h-4 w-4 text-green-600" />
                        ) : (
                          <Copy className="h-4 w-4" />
                        )}
                      </Button>
                    </div>
                    
                    <div className="grid grid-cols-3 gap-4 text-center">
                      <div>
                        <div className="text-lg font-bold text-green-600">{referralInfo.total_referrals}</div>
                        <div className="text-xs text-muted-foreground">Total Referrals</div>
                      </div>
                      <div>
                        <div className="text-lg font-bold text-blue-600">{referralInfo.completed_referrals}</div>
                        <div className="text-xs text-muted-foreground">Completed</div>
                      </div>
                      <div>
                        <div className="text-lg font-bold text-purple-600">{referralInfo.points_earned}</div>
                        <div className="text-xs text-muted-foreground">Points Earned</div>
                      </div>
                    </div>

                    <Alert>
                      <Gift className="h-4 w-4" />
                      <AlertDescription>
                        Your referral code: <strong>{referralInfo.referral_code}</strong>
                      </AlertDescription>
                    </Alert>
                  </div>
                ) : (
                  <div className="text-center py-8">
                    <Gift className="h-12 w-12 mx-auto mb-4 text-muted-foreground" />
                    <h3 className="text-lg font-semibold mb-2">Referral Program</h3>
                    <p className="text-muted-foreground mb-4">
                      Share your referral link and earn 100 points for each friend who joins!
                    </p>
                    <Button onClick={loadReferralInfo}>
                      <Gift className="h-4 w-4 mr-2" />
                      Get Your Referral Link
                    </Button>
                  </div>
                )}
              </CardContent>
            </Card>
          </TabsContent>
        </Tabs>
      </div>
    </Layout>
  );
}
                  
